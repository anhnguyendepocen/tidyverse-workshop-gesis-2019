---
title: "Data transformation"
subtitle: "Verbs that came, saw, and conquered?"
author: "Johannes Breuer<br />Thomas Ebel<br />Stefan MÃ¼ller"
date: "2018-05-16"
location: "GESIS, Mannheim, Germany"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "default-fonts", "../footer-header.css", "../mycss.css"]
    nature:
      highlightStyle: "github"
      highlightLines: true
      countIncrementalSlides: false
---
layout: true

```{r setup, include=FALSE}
if (!require(knitr)) install.packages("knitr")
if (!require(rmarkdown)) install.packages("rmarkdown")
if (!require(tidyverse)) install.packages("tidyverse")
library("knitr")
library("rmarkdown")
library("tidyverse")
options(htmltools.dir.version = FALSE)

opts_chunk$set(echo = FALSE, fig.align = "center")
```

<div class="my-footer">
  <div style="float: left;"><span>`r gsub("<br />", " & ", gsub("<br /><br />|<a.+$", "", metadata$author))`</span></div>
  <div style="float: right;"><span>`r metadata$location`, `r metadata$date`</span></div>
  <div style="text-align: center;"><span>`r gsub(".+<br />", " ", metadata$title)`</span></div>
</div>

---

```{r, include=FALSE, warning=FALSE, error=FALSE}
# devtools::install_github("DavZim/colorTable")
library(colorTable)

# define some colors for later
green <- "#a6d96a"
blue  <- "#74add1"
yellow <- "#f4e842"
```
class: center, middle

<h1> The tidyverse verbs</h1>
<h2> Or: How you never knew you couldn't live without them.</h2>

---

<h2>Verbs</h2>
The tidyverse comes with a range of new functions, called verbs, that make data analysis easier.  
These verbse are provided with the package dplyr.  

The most important verbs are:

* filter (rows)
* arrange (the order of rows)
* select (columns)
* mutate (i.e. create new columns)
* group_by/summarize (create summary/aggregate values)

--

.bottom[
There are a handful of variations, like  
* mutate_if (create new variable dependend on some condition),
* rename (an existing variable and select all),  
and other functions, too.  
]

---

<h2>The flow of things</h2>
All verbs follow the same logic:

Input is a data frame/tibble - do something with it - output is a new data frame/tibble.

--

E.g. the verb "filter"

```{r echo=TRUE, results='hide'}
table1 %>%
  filter(cases < 800)
```

--

1. Input is a tibble, table1
1. Filter this tibble for all rows with "cases" smaller than 800
1. Output is a new tibble

.bottom[
Note, that we are using Non-Standard-Evaluation (NSE) here. Instead of "table1$cases" or "table1[, "cases"] we just say 'cases' (without quotes!). More on that in A4.
]

---

<h2>'filter'</h2>
We already saw 'filter' in action. Now, let's explore it in depth.  

'filter' filters rows dependent on one or more conditions.  

--

You can use the usual operators for 
* comparisons: <, <=, ==, != (not equal), >=, >
   * e.g. 'filter(year != 1999)' and
* logical operators: &, |, ! (not), xor (either or, not both)
  * e.g. 'filter(year == 1999, cases < 3000)'

.bottom[
Note, that multiple conditions in filter are automatically added as '&' ('and').
]

---

<h3>Some examples for filter</h3>

<h4> Not equal </h4>

```{r echo=TRUE}
table1 %>%
  filter(year != 1999)
```

Output is a tibble with all rows where year is not equal to 1999.

---

<h4>Multiple conditions</h4>
```{r echo=TRUE}
table1 %>%
  filter(year == 1999, cases < 40000)
```

Output is a tibble with all rows where year is equal to 1999 and cases is smaller than 40.000.

--

An equivalent - but less canonic way - to express the same thing is 

```{r echo=TRUE}
table1 %>%
  filter(year == 1999 & cases < 40000)
```

---

<h4> Or </h4>
```{r echo=TRUE}
table1 %>%
  filter(year == 1999 | country == "Brazil")
```

Output is a tibble with all rows where either country is Brazil or year is 1999. If both are true that's okay, too. See the seconds row in the output.

---

<h4> Xor </h4>
```{r echo=TRUE}
table1 %>%
  filter(xor(year == 1999, country == "Brazil"))
```

Output very similar to the previous example but one row was dropped: The one that was true for both conditiones (year==1999, country=="Brazil"). That's the difference between '|' and 'xor'.

--

.bottom[
.highlight[Attention:] Never use base R's additional comparison operators '&&' and '||'. They only compare the first element of a vector and do not work in the tidyverse pipes!
]
---


<h2>Verb 'arrange'</h2>

'arrange' changes the order of rows in the data set.  

```{r echo=TRUE}
table1 %>%
  arrange(desc(population))
```

Arrange cases by their population value, in a decreasing order, from big to small.  

---

```{r echo=TRUE}
table1 %>%
  arrange(year, cases)
```

Arrange cases by year, then cases.

.bottom[
Note, that missings are always sorted at the end!
]

---

<h2>Verb 'select'</h2>

We can use 'select' to select the columns/variables that we want to look at.

--

Often we do not want to deal with all variables in a data set because there could be easily hundreds of variables. It's too much to be printed nicely in the console.

```{r echo=TRUE}
table1 %>%
  select(country, cases)
```

---

There are nice helper functions/operators for 'select'.

* colon --> 'select(table1, year.highlight[:]cases)' --> selects all variables **in the range** from year to cases

--

* minus --> 'select(table1, .highlight[-(]year:cases.highlight[)]' --> select all variables **besides** the mentioned ones/range.

--

* 'starts_with'/'ends_with' --> 'select(table1, .highlight[starts_with('c')]) --> select all variables that start/end with string.

--

```{r echo=FALSE}
t_startswith <- tibble(
  'id' = 1:10,
  'w1_x' = sample(x = 1:10, replace = T),
  'w1_y' = sample(x = 1:10, replace = T),
  'w1_z' = sample(x = 1:10, replace = T),
  'w2_x' = sample(x = 1:10, replace = T),
  'w2_y' = sample(x = 1:10, replace = T),
  'w2_z' = sample(x = 1:10, replace = T),
  'w3_x' = sample(x = 1:10, replace = T),
  'w3_y' = sample(x = 1:10, replace = T),
  'w3_z' = sample(x = 1:10, replace = T)
)
glimpse(t_startswith)

```

---

* 'contains' --> 'select(table1, .highlight[contains('u')])' --> select all variables that contain the string.

--

* 'matches' --> 'select(t_startswith, .highlight[matches("^w\\d_z")])' --> select all variables that match a regular expression.
```{r echo=TRUE}
select(t_startswith, matches("^w\\d_z"))
```

--

* everything() --> 'select(table1, cases, .highlight[everything()])' --> used to rearrange the order of variables (here, put "cases" in front).

---



---

class: center, middle

<h2> Thanks!</h2>

Slides created via the R package [**xaringan**](https://github.com/yihui/xaringan).

The chakra comes from [remark.js](https://remarkjs.com), [**knitr**](http://yihui.name/knitr), and [R Markdown](https://rmarkdown.rstudio.com).
