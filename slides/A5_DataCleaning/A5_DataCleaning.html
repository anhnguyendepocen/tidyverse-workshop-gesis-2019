<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Data Wrangling &amp; Exploration with the Tidyverse in R</title>
    <meta charset="utf-8" />
    <meta name="author" content="Johannes Breuer Thomas Ebel Stefan M√ºller" />
    <meta name="date" content="2019-05-15" />
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
    <script src="libs/kePrint/kePrint.js"></script>
    <link rel="stylesheet" href="..\footer-header.css" type="text/css" />
    <link rel="stylesheet" href="..\mycss.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Data Wrangling &amp; Exploration with the Tidyverse in R
## Data Cleaning
### Johannes Breuer<br />Thomas Ebel<br />Stefan M√ºller
### 2019-05-15

---

layout: true



&lt;div class="my-footer"&gt;
  &lt;div style="float: left;"&gt;&lt;span&gt;Johannes Breuer, Thomas Ebel, Stefan M√ºller&lt;/span&gt;&lt;/div&gt;
  &lt;div style="float: right;"&gt;&lt;span&gt;GESIS, Mannheim, Germany, 2019-05-15&lt;/span&gt;&lt;/div&gt;
  &lt;div style="text-align: center;"&gt;&lt;span&gt;Data Cleaning&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;style type="text/css"&gt;

pre {
  font-size: 10px
}
&lt;/style&gt;

---

# Data cleaning

In this section, we will focus on the `dplyr` package.

&lt;img src="./pics/hex-dplyr.png" width="50%" style="display: block; margin: auto;" /&gt;

---

# Data wrangling ü§†

.pull-left[
We split up **wrangling** into...
- **cleaning** (now)
    - renaming variables
    - creating new variables: basics
    - recoding variable values
    - recoding missing values
    - selecting variables: basics
    - filtering cases: basics
    
- **transformation** (1st session tomorrow)
    - advanced creation of new variables
    - working with factors
    - rearranging datasets
    - advanced selecting
    - advanced filtering
    ]

.pull-right[
.center[
&lt;img src="pics/dplyr_wrangling.png"&gt;
]
.smaller[
Artwork by [Allison Horst](https://github.com/allisonhorst/stats-illustrations)
]
]

---

# Titanic üõ≥

For some of the data wrangling examples and exercises we will use the Titanic dataset from [*Kaggle*](https://www.kaggle.com/c/titanic/overview)






&lt;table class="table" style="font-size: 16px; margin-left: auto; margin-right: auto;"&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt; Variable &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Definition &lt;/th&gt;
   &lt;th style="text-align:left;"&gt; Key &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; survival &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Survival &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 0 = No, 1 = Yes &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; pclass &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Ticket class &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; 1 = 1st, 2 = 2nd, 3 = 3rd &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; sex &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Sex &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; Age &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Age in years &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; sibsp &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; # of siblings / spouses aboard the Titanic &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; parch &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; # of parents / children aboard the Titanic &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; ticket &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Ticket number &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; fare &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Passenger fare &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; cabin &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Cabin number &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; NA &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;"&gt; embarked &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; Port of Embarkation &lt;/td&gt;
   &lt;td style="text-align:left;"&gt; C = Cherbourg, Q = Queenstown, S = Southampton &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

---

# Data frame check

It's always good to first check how clean or messy your data is and whether or where it needs cleaning.  

The `glimpse()` function from `dplyr` is usually a good start as it similar to `str()` base R but tries to display as many data points as possible (in the Console).  

The second thing you could/should do (esp. if you have many/mostly numeric variables) is to use the `summary()` function from base R.  

If you want more detailed summaries of your data, you can have a look at the [`skimr`](https://github.com/ropensci/skimr) and [`summarytools`](https://github.com/dcomtois/summarytools) packages.

---

# Data frame check 1


```r
glimpse(titanic)
```

```
## Observations: 891
## Variables: 12
## $ PassengerId &lt;dbl&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,...
## $ Survived    &lt;dbl&gt; 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0,...
## $ Pclass      &lt;dbl&gt; 3, 1, 3, 1, 3, 3, 1, 3, 3, 2, 3, 1, 3, 3, 3, 2, 3,...
## $ Name        &lt;chr&gt; "Braund, Mr. Owen Harris", "Cumings, Mrs. John Bra...
## $ Sex         &lt;chr&gt; "male", "female", "female", "female", "male", "mal...
## $ Age         &lt;dbl&gt; 22, 38, 26, 35, 35, NA, 54, 2, 27, 14, 4, 58, 20, ...
## $ SibSp       &lt;dbl&gt; 1, 1, 0, 1, 0, 0, 0, 3, 0, 1, 1, 0, 0, 1, 0, 0, 4,...
## $ Parch       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 1, 2, 0, 1, 0, 0, 5, 0, 0, 1,...
## $ Ticket      &lt;chr&gt; "A/5 21171", "PC 17599", "STON/O2. 3101282", "1138...
## $ Fare        &lt;dbl&gt; 7.2500, 71.2833, 7.9250, 53.1000, 8.0500, 8.4583, ...
## $ Cabin       &lt;chr&gt; NA, "C85", NA, "C123", NA, NA, "E46", NA, NA, NA, ...
## $ Embarked    &lt;chr&gt; "S", "C", "S", "S", "S", "Q", "S", "S", "S", "C", ...
```

---

# Data frame check 2




```r
summary(titanic_num)
```

```
##   PassengerId       Survived          Pclass           Age       
##  Min.   :  1.0   Min.   :0.0000   Min.   :1.000   Min.   : 0.42  
##  1st Qu.:223.5   1st Qu.:0.0000   1st Qu.:2.000   1st Qu.:20.12  
##  Median :446.0   Median :0.0000   Median :3.000   Median :28.00  
##  Mean   :446.0   Mean   :0.3838   Mean   :2.309   Mean   :29.70  
##  3rd Qu.:668.5   3rd Qu.:1.0000   3rd Qu.:3.000   3rd Qu.:38.00  
##  Max.   :891.0   Max.   :1.0000   Max.   :3.000   Max.   :80.00  
##                                                   NA's   :177    
##      SibSp           Parch             Fare       
##  Min.   :0.000   Min.   :0.0000   Min.   :  0.00  
##  1st Qu.:0.000   1st Qu.:0.0000   1st Qu.:  7.91  
##  Median :0.000   Median :0.0000   Median : 14.45  
##  Mean   :0.523   Mean   :0.3816   Mean   : 32.20  
##  3rd Qu.:1.000   3rd Qu.:0.0000   3rd Qu.: 31.00  
##  Max.   :8.000   Max.   :6.0000   Max.   :512.33  
## 
```

---

# dplyr functions

.large[
- dplyr functions are verbs that signal an action  

- first argument = a data frame  

- output normally also a data frame (tibble) 

- columns (= variables in a tidy data frame) can be referenced without quotation marks (non-standard evaluation)
]

---

# Renaming variables


```r
names(titanic)
```

```
##  [1] "PassengerId" "Survived"    "Pclass"      "Name"        "Sex"        
##  [6] "Age"         "SibSp"       "Parch"       "Ticket"      "Fare"       
## [11] "Cabin"       "Embarked"
```

Some of the names of in the Titanic dataset are difficult to understand (without consulting the codebook). In addition, it is generally helpful to use a consistent naming scheme. As `R` is case-sensitive, we might want to only use lowercase letters. As spaces in variable names can cause problems (or at least headaches), we could opt forüêç snake_case (üê´ camelCase is a common alternative; for a good brief discussion of options for avoiding spaces in variable names, see this [Medium post by Patrick Divine](https://medium.com/@pddivine/string-case-styles-camel-pascal-snake-and-kebab-case-981407998841)).

For common data cleaning tasks, you might also want to have a look at the [`janitor` package](https://github.com/sfirke/janitor) which is tidyverse-oriented and includes the function `clean_names()`.  

---
--- 

# dplyr::rename


```r
titanic &lt;- titanic %&gt;% 
  rename(passenger_id = PassengerId,
         survived = Survived,
         ticket_class = Pclass,
         name = Name,
         sex = Sex,
         age = Age,
         nr_of_siblings_spouses_aboard = SibSp,
         nr_of_parents_children_aboard = Parch,
         ticket_number = Ticket,
         fare = Fare,
         cabin_nr = Cabin,
         port_of_embarkation = Embarked)

names(titanic)
```

```
##  [1] "passenger_id"                  "survived"                     
##  [3] "ticket_class"                  "name"                         
##  [5] "sex"                           "age"                          
##  [7] "nr_of_siblings_spouses_aboard" "nr_of_parents_children_aboard"
##  [9] "ticket_number"                 "fare"                         
## [11] "cabin_nr"                      "port_of_embarkation"
```

---

# Selecting variables

Very often we do not need all the variables in a dataset for our analyses. We can create a selection of columns/variables with the `dplyr` verb `select()`.


```r
titanic %&gt;% 
  select(passenger_id, survived, ticket_class, sex, age)
```

```
## # A tibble: 891 x 5
##    passenger_id survived ticket_class sex      age
##           &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
##  1            1        0            3 male      22
##  2            2        1            1 female    38
##  3            3        1            3 female    26
##  4            4        1            1 female    35
##  5            5        0            3 male      35
##  6            6        0            3 male      NA
##  7            7        0            1 male      54
##  8            8        0            3 male       2
##  9            9        1            3 female    27
## 10           10        1            2 female    14
## # ... with 881 more rows
```

---

# Filtering cases

With the `filter()` function from `dplyr` you can filter rows/observations dependent on one or more conditions.

You can use the usual operators for 
- **comparisons**:
    - **&lt;** (smaller than)
    - **&lt;=** (smaller than or equal to)
    - **==** (equal to)
    - **!=** (not equal to)
    - **&gt;=** (larger than or equal to)
    - **&gt;** (larger than)  
    
- **logical operators**:
    - **&amp;** (and)
    - **|** (or)
    - **!** (not)
    - **xor** (either or, not both)

---

# dplyr::filter - one condition


```r
titanic %&gt;% 
  filter(sex == "male")
```

```
## # A tibble: 577 x 12
##    passenger_id survived ticket_class name  sex     age nr_of_siblings_~
##           &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;            &lt;dbl&gt;
##  1            1        0            3 Brau~ male     22                1
##  2            5        0            3 Alle~ male     35                0
##  3            6        0            3 Mora~ male     NA                0
##  4            7        0            1 McCa~ male     54                0
##  5            8        0            3 Pals~ male      2                3
##  6           13        0            3 Saun~ male     20                0
##  7           14        0            3 Ande~ male     39                1
##  8           17        0            3 Rice~ male      2                4
##  9           18        1            2 Will~ male     NA                0
## 10           21        0            2 Fynn~ male     35                0
## # ... with 567 more rows, and 5 more variables:
## #   nr_of_parents_children_aboard &lt;dbl&gt;, ticket_number &lt;chr&gt;, fare &lt;dbl&gt;,
## #   cabin_nr &lt;chr&gt;, port_of_embarkation &lt;chr&gt;
```

---

# dplyr::filter - multiple conditions


```r
titanic %&gt;% 
  filter(sex == "male", survived == 1, age &gt;= 18)
```

```
## # A tibble: 70 x 12
##    passenger_id survived ticket_class name  sex     age nr_of_siblings_~
##           &lt;dbl&gt;    &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;            &lt;dbl&gt;
##  1           22        1            2 Bees~ male     34                0
##  2           24        1            1 Slop~ male     28                0
##  3           75        1            3 Bing~ male     32                0
##  4           82        1            3 Shee~ male     29                0
##  5           98        1            1 Gree~ male     23                0
##  6          128        1            3 Mads~ male     24                0
##  7          147        1            3 "And~ male     27                0
##  8          188        1            1 "Rom~ male     45                0
##  9          205        1            3 "Coh~ male     18                0
## 10          208        1            3 Albi~ male     26                0
## # ... with 60 more rows, and 5 more variables:
## #   nr_of_parents_children_aboard &lt;dbl&gt;, ticket_number &lt;chr&gt;, fare &lt;dbl&gt;,
## #   cabin_nr &lt;chr&gt;, port_of_embarkation &lt;chr&gt;
```

NB: Multiple conditions in filter are automatically added as &amp; (and).

---

# Creating new variables

In the process of preparing data for analyses we usually want to create new variables (often based on existing ones). For example, in the Titanic dataset, we might want to calculate the total number of relatives aboard the Titanic for each passenger.


```r
titanic &lt;- titanic %&gt;% 
  mutate(nr_of_relatives_aboard = nr_of_siblings_spouses_aboard +
           nr_of_parents_children_aboard)

titanic %&gt;% 
  select(nr_of_relatives_aboard) %&gt;% 
  filter(nr_of_relatives_aboard &gt; 1) %&gt;% 
  head(n = 5)
```

```
## # A tibble: 5 x 1
##   nr_of_relatives_aboard
##                    &lt;dbl&gt;
## 1                      4
## 2                      2
## 3                      2
## 4                      6
## 5                      5
```

---

# Recoding variable values


```
## # A tibble: 6 x 1
##   port_of_embarkation
##   &lt;chr&gt;              
## 1 S                  
## 2 C                  
## 3 S                  
## 4 S                  
## 5 S                  
## 6 Q
```

Without looking at the codebook, it is not clear what the letters in the *Embarked* variable stand for. If we want to, e.g., produce tables or plots using this variable, it might help to replace the abbreviation by the full name of the port of embarkation.

---

# dplyr::recode


```r
titanic %&gt;% 
  mutate(port_of_embarkation = recode(port_of_embarkation,
         S = "Southampton",
         C = "Cherbourg",
         Q = "Queenstown")) %&gt;% 
  select(port_of_embarkation) %&gt;% 
  head()
```

```
## # A tibble: 6 x 1
##   port_of_embarkation
##   &lt;chr&gt;              
## 1 Southampton        
## 2 Cherbourg          
## 3 Southampton        
## 4 Southampton        
## 5 Southampton        
## 6 Queenstown
```

Note that we recode into the same variable here
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
