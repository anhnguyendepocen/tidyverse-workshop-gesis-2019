---
title: "Importing Data"
# subtitle: "(according to Hadley Wickham/RStudio)"
author: "Johannes Breuer<br />Thomas Ebel<br />Stefan MÃ¼ller"
date: "2019-05-15"
location: "GESIS, Mannheim, Germany"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "robot-fonts", "../footer-header.css", "../mycss.css"]
    nature:
      highlightStyle: "github"
      highlightLines: true
      countIncrementalSlides: false
---
layout: true

```{r setup, include = FALSE}
packages_to_load <- c("knitr", "rmarkdown", "tidyverse", "readr", "readxl",
                      "haven")

for (i in packages_to_load) {
  if (!require(i, character.only = TRUE)) {
    install.packages(i)
  } else {
    library(i, character.only = TRUE)
  }
}

rm(packages_to_load)

options(htmltools.dir.version = FALSE)

opts_chunk$set(echo = FALSE, fig.align = "center")
```

<div class="my-footer">
  <div style="float: left;"><span>`r gsub("<br />", " & ", gsub("<br /><br />|<a.+$", "", metadata$author))`</span></div>
  <div style="float: right;"><span>`r metadata$location`, `r metadata$date`</span></div>
  <div style="text-align: center;"><span>`r gsub(".+<br />", " ", metadata$title)`</span></div>
</div>

---
<h1> Data, Data, Data </h1> 

.large[
Thus far, we've already learned that data can be untidy.

This course is all about making them tidy again (...or maybe for the first time?).

There's one rather important prerequisite, however:

.center[**We need data!**]
]

```{r, out.width = "50%"}
include_graphics("./import_data.png")
```

---
<h1> Getting Data in the tidyverse </h1>

Whether we want to use our own data or that from others, we need to get data into R.

tidyverse provides some nice tools to do so:

- `readr`  (for 'flat' files, such as CSV)
- `readxl` (for excel spreadsheets)
- `haven`  (for statistical software files, such as SPSS, Stata, and SAS)

```{r, out.width = "50%"}
include_graphics("./hex_all_in_one.png")
```

The difference to other tool is that tidyverse import functions already prepare the data for being 'tidyed': they are a tibbles


---
# A readr example: `read_csv()`
```{r readr_example, echo = TRUE}
titanic <- read_csv("../../data/titanic/titanic.csv")
```

---
# A readr example: `read_csv()`
```{r readr_example:output, echo = TRUE}
titanic
```

It's that easy.

---
# A readxl example: `read_excel()`
```{r readxl_example, echo = TRUE}
unicorns <- read_xlsx("../../data/unicorns/observations.xlsx")
```

No output :-(

---
# A readxl example: `read_excel()`
```{r readxl_example_output, echo = TRUE}
unicorns
```

---
# A haven example: `read_stata()` 
```{r read_stata_example, echo = TRUE}
gesis_panel <- 
  read_stata("../../data/gesis_panel_campusfile/ZA5666_v1-0-0_Stata14.dta")
```

---
# A haven example: `read_stata()` 
```{r read_stata_example_output, echo = TRUE}
gesis_panel
```

---
# There's More
These were just some very first examples of applying functions from each package.

- readr
  - `read_csv()`
  - `read_tsv()`
  - `read_delim()`
  - `read_fwf()`
  - `read_table()`
  - `read_log()`
- haven
  - `read_sas()`
  - `read_spss()`
  - `read_stata()`

Not to mention all the helper files and options. For example, we can define the cells to read from an excel file by applying the option `range = "C1:E4"` in
`read_excel()`


---
# Data Specifics
- characters
  - indicated by `<chr>`
  - specified by `col_character()`
- integers
  - indicated by `XXX`
  - specified by `col_integer()`
- doubles
  - indicated by `<dbl>`
  - specified by `col_double()`
- factors
  - indicated by `XXX`
  - specified by `col_factor()`
- logical
  - indicated by `<lgl>`
  - specified by `col_logical()`
  
.center[**There's more, but we'll leave it for now.**]

---
# Changing Variable Types
For example, `read_csv` 'guesses' the variable types

  - it scans the first 1000 oberservations

This can go wrong!

Luckily, we can change the variable type -- before and after loading the data

---
# While Loading the data in `read_csv`
```{r readr_example_col_change, echo = TRUE}
titanic <-
  read_csv(
    "../../data/titanic/titanic.csv",
    col_types = cols(
      PassengerId = col_double(),
      Survived = col_double(),
      Pclass = col_double(),
      Name = col_character(),
      Sex = col_character(),
      Age = col_double(),
      SibSp = col_double(),
      Parch = col_double(),
      Ticket = col_character(),
      Fare = col_double(),
      Cabin = col_character(),
      Embarked = col_character()
    )
  )
```

---
# While Loading the data in `read_csv`
```{r readr_example_col_change_display, echo = TRUE}
titanic
```

---
# While Loading the data in `read_csv`
```{r readr_example_col_changeD, echo = TRUE}
titanic <-
  read_csv(
    "../../data/titanic/titanic.csv",
    col_types = cols(
      PassengerId = col_double(),
      Survived = col_double(),
      Pclass = col_double(),
      Name = col_character(),
      Sex = col_factor(), # This one's now changed!
      Age = col_double(),
      SibSp = col_double(),
      Parch = col_double(),
      Ticket = col_character(),
      Fare = col_double(),
      Cabin = col_character(),
      Embarked = col_character()
    )
  )
```

---
# While Loading the data in `read_csv`
```{r readr_example_col_changeD_display, echo = TRUE}
titanic
```

---
# After Loading the data
```{r readr_example_col_change_after, echo = TRUE}
titanic <- read_csv("../../data/titanic/titanic.csv")
```

---
# After Loading the data
```{r readr_example_col_changeD_after, echo = TRUE}
titanic <-
  type_convert(
    titanic,
    col_types = cols(
      PassengerId = col_double(),
      Survived = col_double(),
      Pclass = col_double(),
      Name = col_character(),
      Sex = col_factor(), # This one's now changed!
      Age = col_double(),
      SibSp = col_double(),
      Parch = col_double(),
      Ticket = col_character(),
      Fare = col_double(),
      Cabin = col_character(),
      Embarked = col_character()
    )
  )
```

---
# Exporting Data
Sometimes we also have to leave R and its tidy world.

- We share data with colleagues
- We wanna start where we left the next day
  - Particularly, when data tidying to a long time
  
For these purposes, we also have to need a way to export our data.

All tools presented also have designated functions for that.

```{r, out.width = "50%"}
include_graphics("./export_data.png")
```

---
# Example: CSV and Stata files
```{r export_csv, echo = TRUE}
write_csv(titanic, "titanic_own.csv")
```

Maybe more relevant:
```{r export_stata, echo = TRUE}
write_dta(titanic, "titanic_own.dta")
```

Proof that they have been exported:
```{r list_files, echo = TRUE}
list.files() 
```

---
# Additional Packages
The great benefit of tidyverse import functions is the import of the data as tibbles: the data are potentially more tidy.

Several other non-tidyverse packages provide similar benefits as they make use of this universal data format:
- `sf` for geospatial data
- `sjlabelled` to work with labelled data, e.g., from SPSS or Stata

---
# Alternative Packages

- `base` R
- the good old `foreign` package for spss and stata files 
- `data.table` for large data tables

---
# Exercise: Pick One From the Pool of Data







